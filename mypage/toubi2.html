<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜æ€»å®¶çš„æŠ•å¸æœº - ä¸“å±å®šåˆ¶ç‰ˆ</title>
    <style>
        body {
            background-color: #1a1a2e;
            color: #fff;
            font-family: 'å¾®è½¯é›…é»‘', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }
        h1 { color: #ff3366; text-shadow: 0 0 10px #ff3366; margin-bottom: 5px; }
        .subtitle { color: #aaa; margin-bottom: 20px; font-size: 14px; }
        .game-wrapper { display: flex; flex-direction: row; gap: 30px; justify-content: center; flex-wrap: wrap; }
        
        .slot-machine {
            background-color: #16213e; border: 5px solid #e94560; border-radius: 15px; 
            padding: 20px; box-shadow: 0 0 30px #e94560; text-align: center; width: 320px;
        }
        .grid { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .row { display: flex; gap: 10px; justify-content: center; }
        .reel {
            width: 70px; height: 80px; background-color: #fff; color: #000;
            font-size: 40px; display: flex; align-items: center; justify-content: center;
            border-radius: 8px; border: 3px solid #0f3460; box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }
        .win-reel { background-color: #ffd700 !important; box-shadow: 0 0 15px #ffd700; transform: scale(1.05); }

        .inserter-panel {
            background-color: #0f3460; border: 5px solid #4cffd7; border-radius: 15px;
            padding: 20px; box-shadow: 0 0 30px #4cffd7; display: flex; flex-direction: column;
            align-items: center; width: 320px;
        }
        .mini-game {
            width: 100%; height: 200px; background-color: #1a1a2e; border: 2px solid #555;
            border-radius: 10px; position: relative; overflow: hidden; margin-bottom: 20px;
        }
        
        .chute {
            position: absolute; top: 10px; left: 0; width: 40px;
            border-top: 35px solid #aaa; border-left: 15px solid transparent; border-right: 15px solid transparent;
            animation: swing 0.6s infinite ease-in-out alternate; z-index: 10;
        }
        .receiver {
            position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%);
            width: 40px; height: 30px; border: 4px solid #fca311; border-top: none;
            border-radius: 0 0 15px 15px; background: rgba(252, 163, 17, 0.4);
            display: flex; align-items: center; justify-content: center; color: #fca311; font-size: 12px; font-weight: bold;
        }
        .falling-coin {
            position: absolute; width: 30px; height: 30px; font-size: 24px;
            line-height: 30px; text-align: center; transition: top 0.35s ease-in; z-index: 5;
        }

        @keyframes swing { 0% { transform: translateX(10px); } 100% { transform: translateX(230px); } }

        button {
            width: 100%; background-color: #e94560; color: white; border: none;
            padding: 15px 0; font-size: 20px; font-weight: bold; border-radius: 8px;
            cursor: pointer; transition: 0.1s;
        }
        button:hover { background-color: #ff3366; transform: scale(1.02); }
        button:active { transform: scale(0.95); }

        #message { margin-top: 15px; font-size: 18px; font-weight: bold; color: #4cffd7; height: 50px; line-height: 1.5; }
        .queue-box { color: #fca311; font-size: 24px; font-weight: bold; background: #0f3460; padding: 2px 10px; border-radius: 10px; margin-left: 5px;}
        .stats { margin-top: 20px; font-size: 20px; color: #aaa; background: #16213e; padding: 10px 30px; border-radius: 20px; border: 2px solid #fca311; }
    </style>
</head>
<body>

    <h1>ğŸ© å¤§é­”æœ¯å¸ˆ - ç‹‚æš´è¿å‘ç‰ˆ ğŸª„</h1>
    <div class="subtitle">ç‚¹å‡»ä»»æ„ä½ç½®æ¿€æ´»éŸ³æ•ˆå¼•æ“ï¼å°½æƒ…ç–¯ç‹‚æŒ‰æŠ•å¸å§ï¼</div>
    
    <div class="game-wrapper">
        <div class="slot-machine">
            <div class="grid" id="grid">
                <div class="row" id="row0"><div class="reel" id="r00">ğŸ’</div><div class="reel" id="r01">ğŸ’</div><div class="reel" id="r02">ğŸ’</div></div>
                <div class="row" id="row1"><div class="reel" id="r10">ğŸ’</div><div class="reel" id="r11">ğŸ’</div><div class="reel" id="r12">ğŸ’</div></div>
                <div class="row" id="row2"><div class="reel" id="r20">ğŸ•Šï¸</div><div class="reel" id="r21">ğŸ•Šï¸</div><div class="reel" id="r22">ğŸ•Šï¸</div></div>
            </div>
            <div id="message">é«˜æ€»å®¶çš„æŠ•å¸æœº<br>ç¡¬å¸ä½™é¢ï¼š<span class="queue-box" id="msgCoins">5000</span></div>
        </div>

        <div class="inserter-panel">
            <div class="mini-game" id="miniGame">
                <div class="chute" id="chute"></div>
                <div class="receiver" id="receiver">IN</div>
            </div>
            <button id="dropBtn" onclick="dropCoin()">ğŸ‘‡ ç‹‚ç‚¹æŠ•å¸</button>
        </div>
    </div>

    <div class="stats">
        æ€»èµ„äº§ï¼š<span id="coins" style="color: #fca311; font-weight: bold; font-size: 28px;">5000</span> ğŸ’°
    </div>

    <script>
        // ==========================================
        // çº¯ JS Web Audio API 
        // ==========================================
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playBeep(freq, type, duration, vol=0.1) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            let osc = audioCtx.createOscillator();
            let gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        function playSound(type) {
            if (type === 'insert') playBeep(800, 'sine', 0.1, 0.2); 
            else if (type === 'hit') { playBeep(1200, 'square', 0.1, 0.1); setTimeout(()=>playBeep(1600, 'square', 0.1, 0.1), 80); } 
            else if (type === 'miss') playBeep(200, 'sawtooth', 0.2, 0.1); 
            else if (type === 'win') { 
                [523, 659, 783, 1046, 1318].forEach((f, i) => {
                    setTimeout(() => playBeep(f, 'square', 0.3, 0.15), i * 100);
                });
            }
        }

        // ==========================================
        // æ¸¸æˆæ ¸å¿ƒé€»è¾‘
        // ==========================================
        const symbols = ['ğŸ©', 'ğŸ•Šï¸', 'ğŸ‘‘', 'ğŸ’', 'ğŸ', 'ğŸ’']; 
        let coins = 5000; 
        
        let isSpinning = false;
        let spinQueue = 0; 

        const targetRTP = 0.8; 
        let internalPool = 1000; 

        function dropCoin() {
            if (coins <= 0) return; // æ²¡é’±äº†å°±ä¸æ‰§è¡Œ
            
            coins--;
            updateCoins();
            playSound('insert'); 

            const chute = document.getElementById('chute');
            const miniGame = document.getElementById('miniGame');
            const chuteRect = chute.getBoundingClientRect();
            const gameRect = miniGame.getBoundingClientRect();
            
            const startX = chuteRect.left - gameRect.left + (chuteRect.width / 2) - 15;

            const dropCoinEl = document.createElement('div');
            dropCoinEl.className = 'falling-coin';
            dropCoinEl.innerText = 'ğŸª™';
            dropCoinEl.style.left = startX + 'px';
            dropCoinEl.style.top = '40px'; 
            miniGame.appendChild(dropCoinEl);

            void dropCoinEl.offsetWidth; 
            dropCoinEl.style.top = '165px'; 

            setTimeout(() => {
                const receiver = document.getElementById('receiver');
                const recRect = receiver.getBoundingClientRect();
                const coinRect = dropCoinEl.getBoundingClientRect();
                const coinCenterX = coinRect.left + coinRect.width / 2;

                if (coinCenterX >= recRect.left && coinCenterX <= recRect.right) {
                    dropCoinEl.innerHTML = 'âœ¨';
                    playSound('hit');
                    
                    spinQueue++; 
                    checkQueue(); 
                    
                    setTimeout(() => dropCoinEl.remove(), 200);
                } else {
                    dropCoinEl.style.opacity = 0;
                    playSound('miss');
                    setTimeout(() => dropCoinEl.remove(), 200);
                }
            }, 350);
        }

        function checkQueue() {
            if (isSpinning || spinQueue <= 0) return; 
            spinQueue--;
            triggerSlotMachine();
        }

        function triggerSlotMachine() {
            isSpinning = true;
            clearHighlights();

            internalPool += (1 * targetRTP); 
            
            let finalGrid = generateRandomGrid();
            let payoutInfo = calculatePayout(finalGrid);
            
            if (payoutInfo.totalWin > internalPool) {
                finalGrid = forceLossGrid();
                payoutInfo = calculatePayout(finalGrid);
            } else {
                internalPool -= payoutInfo.totalWin;
            }

            let spinsCount = 0;
            const maxSpins = 12; 

            let interval = setInterval(() => {
                for(let r=0; r<3; r++) {
                    for(let c=0; c<3; c++) {
                        document.getElementById(`r${r}${c}`).innerText = symbols[Math.floor(Math.random() * symbols.length)];
                    }
                }
                spinsCount++;

                if (spinsCount >= maxSpins) {
                    clearInterval(interval);
                    
                    for(let r=0; r<3; r++) {
                        for(let c=0; c<3; c++) {
                            document.getElementById(`r${r}${c}`).innerText = finalGrid[r][c];
                        }
                    }
                    finishSpin(payoutInfo);
                }
            }, 50);
        }

        function finishSpin(payoutInfo) {
            if (payoutInfo.totalWin > 0) {
                coins += payoutInfo.totalWin;
                playSound('win'); 
                
                payoutInfo.winRows.forEach(rowIndex => {
                    document.getElementById(`r${rowIndex}0`).classList.add('win-reel');
                    document.getElementById(`r${rowIndex}1`).classList.add('win-reel');
                    document.getElementById(`r${rowIndex}2`).classList.add('win-reel');
                });
            }
            // å¼€å¥–åç«‹åˆ»åŒæ­¥æœ€æ–°ä½™é¢
            updateCoins();

            setTimeout(() => {
                isSpinning = false;
                if (spinQueue > 0) {
                    checkQueue(); 
                }
            }, 400);
        }

        function generateRandomGrid() {
            let grid = [];
            for (let i = 0; i < 3; i++) {
                grid.push([symbols[Math.floor(Math.random() * symbols.length)], symbols[Math.floor(Math.random() * symbols.length)], symbols[Math.floor(Math.random() * symbols.length)]]);
            }
            return grid;
        }

        function forceLossGrid() {
            let grid = [];
            for (let i = 0; i < 3; i++) {
                let row = [];
                do {
                    row = [symbols[Math.floor(Math.random() * symbols.length)], symbols[Math.floor(Math.random() * symbols.length)], symbols[Math.floor(Math.random() * symbols.length)]];
                } while (row[0] === row[1] && row[1] === row[2]);
                grid.push(row);
            }
            return grid;
        }

        function calculatePayout(grid) {
            let totalWin = 0;
            let winRows = []; 
            for(let i=0; i<3; i++) {
                if(grid[i][0] === grid[i][1] && grid[i][1] === grid[i][2]) {
                    winRows.push(i);
                    if (grid[i][0] === 'ğŸ©') totalWin += 50; 
                    else if (grid[i][0] === 'ğŸ’') totalWin += 30;
                    else if (grid[i][0] === 'ğŸ‘‘') totalWin += 20;
                    else totalWin += 10;
                }
            }
            return { totalWin: totalWin, winRows: winRows };
        }

        function clearHighlights() {
            document.querySelectorAll('.reel').forEach(el => el.classList.remove('win-reel'));
        }
        
        // æ ¸å¿ƒæ›´æ–°ï¼šåŒæ­¥ä¿®æ”¹ä¸¤ä¸ªåœ°æ–¹çš„ç¡¬å¸æ˜¾ç¤º
        function updateCoins() {
            document.getElementById('coins').innerText = coins;       // åº•éƒ¨ç»Ÿè®¡åŒºåŸŸ
            document.getElementById('msgCoins').innerText = coins;    // ä¸­é—´æç¤ºè¯­åŒºåŸŸ
        }
    </script>
</body>
</html>